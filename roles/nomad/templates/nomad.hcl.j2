datacenter = "{{ nomad_datacenter_name }}"
data_dir = "{{ __nomad_data_dir }}"
name = "{{ inventory_hostname | regex_replace('\.','-') }}"


tls {
  http = true
  rpc  = true
  ca_file     = "{{ __nomad_ca_certificate }}"
  cert_file   = "{{ __nomad_self_certificate }}"
  key_file    = "{{ __nomad_self_private_key }}"
}

advertise {
  http = "nomad.{{ public_domain }}"
}

telemetry {
  collection_interval = "1s"
  disable_hostname = true
  prometheus_metrics = true
  publish_allocation_metrics = true
  publish_node_metrics = true
}

acl {
  enabled = true
}

{% if __nomad_is_master %}
#
# BEGIN - master-only configuration
#
consul {
  token      = "{{ __nomad_is_master | ternary(consul_connect_token_server, consul_connect_token_client) }}"
  ssl        = true
  verify_ssl = true
  address    = "{{ nomad_node_fqdn }}:8501"
}

server {
    enabled = true
    bootstrap_expect = {{ nomad_bootstrap_expect }}
    encrypt = "{{ __nomad_encrypt_key }}"
}

client {
  enabled = false
}
#
# END - master-only configuration
#
{% else %}
#
# BEGIN - minion-only configuration
#
consul {
  token      = "{{ __nomad_is_master | ternary(consul_connect_token_server, consul_connect_token_client) }}"
  ssl        = true
  verify_ssl = true
  address    = "localhost:8501"
}

client {
  enabled = true

{% for nomad_volume in nomad_volumes %}
  host_volume "{{ nomad_volume.name }}" {
    path      = "{{ nomad_volume.path }}"
    read_only = {{ nomad_volume.read_only | string | lower }}
  }
{% endfor %}

  meta {    
    "connect.sidecar_image" = "envoyproxy/envoy-alpine:v1.21.2"  
    "connect.gateway_image" = "envoyproxy/envoy-alpine:v1.21.2"  
    "connect.log_level" = "debug"
  }
}

plugin "docker" {
  config {
    volumes {
      enabled      = true
    }

  }
}

plugin "raw_exec" {
  config {
    enabled = true
  }
}

#
# END - minion-only configuration
#
{% endif %}

